<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head.ejs', { title: 'Create Bambi bambi' }) %>
<body>
  <%- include('../partials/nav.ejs') %>
  
  <div class="container">
    <div class="creation-container">
      <h1 class="neon-text">Create Bambi bambi</h1>
      
      <form action="/bambis" method="POST" class="bambi-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="displayName">Display Name</label>
          <input type="text" id="displayName" name="displayName" required>
        </div>
        
        <div class="form-group">
          <label for="about">About Me</label>
          <textarea id="about" name="about" rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label for="avatar">bambi Picture</label>
          <input type="file" id="avatar" name="avatar" accept="image/*">
        </div>
        
        <div class="form-actions">
          <button type="submit" class="submit-btn">Create bambi</button>
          <a href="/bambis" class="cancel-btn">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  <%- include('../partials/footer.ejs', { footer: typeof footer !== 'undefined' ? footer : {} }) %>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize form validation
      const form = document.querySelector('.bambi-form');
      
      // Check for bambiname first
      function getBambiNameFromCookie() {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; bambiname=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        return null;
      }
      
      const bambiname = getBambiNameFromCookie() || localStorage.getItem('bambiname');
      
      if (!bambiname) {
        // No bambiname, show modal or redirect
        const authModal = document.getElementById('username-modal');
        if (authModal) {
          authModal.style.display = 'block';
        } else {
          window.location.href = '/?error=You must set a BambiName before creating a profile';
        }
      }
      
      // Rest of your code...
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Re-check bambiname before submission
          const currentBambiname = getBambiNameFromCookie() || localStorage.getItem('bambiname');
          if (!currentBambiname) {
            window.location.href = '/?error=You must set a BambiName before creating a profile';
            return;
          }
          
          // Use the form validation from bambi-forms.js
          if (window.validateForm && !window.validateForm(this)) {
            return;
          }
          
          // Continue with form submission
          this.submit();
        });
      }
      
      // Check server-side authentication status
      fetch('/api/auth/status')
        .then(res => res.json())
        .then(data => {
          if (!data.authenticated) {
            const authModal = document.getElementById('username-modal');
            if (authModal) {
              authModal.style.display = 'block';
            } else {
              console.log('Authentication needed but modal not found');
              window.location.href = '/?error=Please set a bambiname first';
            }
          } else {
            window.username = data.username;
          }
        })
        .catch(err => {
          console.error('Authentication check failed:', err);
        });

      // Initialize BambiSocket if available
      if (window.BambiSocket) {
        window.BambiSocket.initialize();
      }
    });
  </script>
</body>
</html>