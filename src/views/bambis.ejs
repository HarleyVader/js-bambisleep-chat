<!DOCTYPE html>
<html lang="en">
<%- include('../views/partials/head.ejs') %>
  <title><%= locals.bambi ? `${bambi.displayName || bambi.username} | Bambisleep.chat` : 'Bambi Profiles | Bambisleep.chat' %></title>
  <link rel="stylesheet" href="/css/bambis.css">
<body>
  <%- include('../views/partials/nav.ejs') %>
  
  <main class="container" style="width: 95%; max-width: 95%;">
    <% if (locals.bambi) { %>
      <!-- SINGLE PROFILE VIEW -->
      <a href="/bambis" class="back-to-profiles"><i class="fas fa-arrow-left"></i> Back to Profiles</a>
      
      <div class="profile-container">
        <div class="profile-header">
          <img src="<%= bambi.profilePictureUrl %>" alt="<%= bambi.displayName || bambi.username %>" class="profile-avatar">
        </div>
        
        <div class="profile-details">
          <div class="profile-header-row">
            <div class="profile-name-container">
              <h1 class="profile-name"><%= bambi.displayName || bambi.username %></h1>
              <div class="profile-username">@<%= bambi.username %></div>
            </div>
            
            <div class="profile-stats">
              <div class="stat">
                <div class="stat-value"><%= bambi.level %></div>
                <div class="stat-label">Level</div>
              </div>
              
              <div class="stat">
                <div class="stat-value"><%= bambi.triggers.length %></div>
                <div class="stat-label">Triggers</div>
              </div>
              
              <div class="stat">
                <div class="stat-value"><%= bambi.favoriteFiles.length %></div>
                <div class="stat-label">Favorite Files</div>
              </div>
              
              <div class="stat">
                <div class="stat-value heart-container">
                  <span id="heartCount"><%= bambi.hearts ? bambi.hearts.count : 0 %></span>
                  <button id="heartButton" class="heart-button">
                    <i class="fas fa-heart"></i>
                  </button>
                </div>
                <div class="stat-label">Hearts</div>
              </div>
              
              <button id="shareProfileBtn" class="share-profile-btn">
                <i class="fas fa-share-alt"></i> Share
              </button>
            </div>
          </div>
          
          <div class="profile-description">
            <%= bambi.description || 'No description provided' %>
          </div>
          
          <div class="profile-triggers">
            <h3 class="triggers-title">Triggers</h3>
            
            <div class="trigger-tags">
              <% if (bambi.triggers && bambi.triggers.length > 0) { %>
                <% bambi.triggers.forEach(trigger => { %>
                  <div class="trigger-tag"><%= trigger %></div>
                <% }) %>
              <% } else { %>
                <p>No triggers added yet</p>
              <% } %>
            </div>
          </div>
          
          <div class="profile-activity">
            <h3>Recent Activity</h3>
            <div class="activity-feed">
              <% if (bambi.activities && bambi.activities.length > 0) { %>
                <% bambi.activities.slice(0, 5).forEach(activity => { %>
                  <div class="activity-item">
                    <div class="activity-icon">
                      <% if (activity.type === 'file') { %>
                        <i class="fas fa-file-audio"></i>
                      <% } else if (activity.type === 'level') { %>
                        <i class="fas fa-arrow-up"></i>
                      <% } else if (activity.type === 'badge') { %>
                        <i class="fas fa-award"></i>
                      <% } else if (activity.type === 'heart') { %>
                        <i class="fas fa-heart"></i>
                      <% } else { %>
                        <i class="fas fa-star"></i>
                      <% } %>
                    </div>
                    <div class="activity-details">
                      <p><%= activity.description %></p>
                      <small><%= new Date(activity.timestamp).toLocaleString() %></small>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <p>No recent activity</p>
              <% } %>
            </div>
          </div>
          
          <button id="editProfileBtn" class="edit-profile-btn">Edit Profile</button>
        </div>
        
        <div id="editForm" class="edit-form">
          <h2>Edit Your Profile</h2>
          <form id="profileEditForm">
            <div class="form-group">
              <label for="displayNameEdit">Display Name</label>
              <input type="text" id="displayNameEdit" name="displayName" value="<%= bambi.displayName || '' %>" placeholder="Your display name">
            </div>
            
            <div class="form-group">
              <label for="descriptionEdit">About You</label>
              <textarea id="descriptionEdit" name="description" rows="4" placeholder="Tell us about yourself..."><%= bambi.description || '' %></textarea>
            </div>
            
            <div class="form-group">
              <label for="profilePictureEdit">Profile Picture</label>
              <input type="file" id="profilePictureEdit" name="profilePicture" accept="image/*">
            </div>
            
            <div class="form-group">
              <label>Triggers</label>
              <div id="triggersList" class="triggers-input">
                <% if (bambi.triggers && bambi.triggers.length > 0) { %>
                  <% bambi.triggers.forEach(trigger => { %>
                    <div class="trigger-pill" data-value="<%= trigger %>">
                      <%= trigger %><span class="remove-trigger">Ã—</span>
                    </div>
                  <% }) %>
                <% } %>
              </div>
              <input type="text" id="newTrigger" placeholder="Type a trigger and press Enter">
            </div>
            
            <div class="form-group">
              <label>Profile Theme</label>
              <div class="theme-customizer">
                <div class="color-picker">
                  <label for="primaryColor">Primary Color:</label>
                  <input type="color" id="primaryColor" name="primaryColor" value="<%= bambi.profileTheme?.primaryColor || '#fa81ff' %>">
                </div>
                
                <div class="color-picker">
                  <label for="secondaryColor">Secondary Color:</label>
                  <input type="color" id="secondaryColor" name="secondaryColor" value="<%= bambi.profileTheme?.secondaryColor || '#ff4fa2' %>">
                </div>
                
                <div class="color-picker">
                  <label for="textColor">Text Color:</label>
                  <input type="color" id="textColor" name="textColor" value="<%= bambi.profileTheme?.textColor || '#ffffff' %>">
                </div>
                
                <div class="preview-box" id="themePreview">
                  <span>Theme Preview</span>
                </div>
              </div>
            </div>
            
            <button type="submit" class="edit-profile-btn">Save Changes</button>
          </form>
        </div>
      </div>
    <% } else { %>
      <!-- PROFILES LIST VIEW -->
      <h1>Bambi Profiles</h1>
      
      <% if (locals.error) { %>
        <div class="error-message">
          <%= error %>
        </div>
      <% } %>
      
      <div class="create-profile-section">
        <h2>Create Your Bambi Profile</h2>
        <form id="createProfileForm">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required minlength="3" placeholder="Your unique bambi name">
          </div>
          
          <div class="form-group">
            <label for="displayName">Display Name (optional)</label>
            <input type="text" id="displayName" name="displayName" placeholder="Your display name">
          </div>
          
          <div class="form-group">
            <label for="description">About You</label>
            <textarea id="description" name="description" rows="4" placeholder="Tell us about yourself..."></textarea>
          </div>
          
          <button type="submit">Create Profile</button>
        </form>
      </div>
      
      <% if (locals.bambis && bambis.length > 0) { %>
        <div class="profiles-container">
          <% bambis.forEach(bambi => { %>
            <div class="profile-card">
              <img src="<%= bambi.profilePictureUrl %>" alt="<%= bambi.displayName || bambi.username %>" class="profile-image">
              <div class="profile-info">
                <h3 class="profile-name"><a href="/bambis/<%= bambi.username %>"><%= bambi.displayName || bambi.username %></a></h3>
                <p class="profile-description"><%= bambi.description || 'No description provided' %></p>
                <div class="profile-details">
                  <span>Level: <%= bambi.level %></span>
                  <span>
                    <i class="fas fa-heart" style="color: #ff4fa2;"></i> 
                    <%= bambi.hearts ? bambi.hearts.count : 0 %>
                  </span>
                  <span>Triggers: <%= bambi.triggers ? bambi.triggers.length : 0 %></span>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
        
        <!-- Pagination -->
        <% if (locals.totalPages && totalPages > 1) { %>
          <div class="pagination">
            <% if (currentPage > 1) { %>
              <a href="/bambis?page=<%= currentPage - 1 %>">Previous</a>
            <% } %>
            
            <% for (let i = 1; i <= totalPages; i++) { %>
              <% if (i === currentPage) { %>
                <span class="active"><%= i %></span>
              <% } else { %>
                <a href="/bambis?page=<%= i %>"><%= i %></a>
              <% } %>
            <% } %>
            
            <% if (currentPage < totalPages) { %>
              <a href="/bambis?page=<%= currentPage + 1 %>">Next</a>
            <% } %>
          </div>
        <% } %>
      <% } else if (!locals.error) { %>
        <div class="empty-state">
          <p>No bambi profiles found. Be the first to create one!</p>
        </div>
      <% } %>
    <% } %>
  </main>
  
  <%- include('../views/partials/footer.ejs') %>
  <script src="/js/bambis.js"></script>
</body>
</html>