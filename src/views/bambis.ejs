<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head.ejs', { title: 'BambiSleep Community' }) %>
<body>
  <%- include('./partials/nav.ejs') %>
  
  <div class="container">
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="error-message">
        <%= typeof errorMessage !== 'undefined' ? errorMessage : 'An error occurred' %>
      </div>
    <% } %>
    
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="success-message">
        <%= success %>
      </div>
    <% } %>

    <div class="page-header">
      <h1>BambiSleep Community</h1>
      <p class="subtitle">Connect with other Bambis and explore the forest together</p>
    </div>

    <div class="bambi-search">
      <form action="/bambis" method="GET" class="search-form">
        <input 
          type="text" 
          name="search" 
          placeholder="Search bambis..." 
          value="<%= typeof search !== 'undefined' ? search : '' %>"
          class="search-input"
        >
        <button type="submit" class="search-button">üîç</button>
      </form>
    </div>

    <div class="bambi-sort">
      <span class="sort-label">Sort by:</span>
      <div class="sort-options">
        <% 
          const currentSort = typeof sort !== 'undefined' ? sort : 'updatedAt';
          const options = [
            {value: 'updatedAt', label: 'Last Active'},
            {value: 'username', label: 'Username'},
            {value: 'hearts', label: 'Hearts'},
            {value: 'views', label: 'Views'}
          ];
        %>
        
        <% options.forEach(option => { %>
          <a 
            href="/bambis?sort=<%= option.value %><%= typeof search !== 'undefined' && search ? `&search=${encodeURIComponent(search)}` : '' %>" 
            class="sort-option <%= currentSort === option.value ? 'active' : '' %>"
          >
            <%= option.label %>
          </a>
        <% }); %>
      </div>
    </div>

    <div class="create-bambi-section">
      <h2>Join Our Community</h2>
      <p>Share your journey into blissful mindlessness with others</p>
      
      <a href="/bambis/new" class="join-community-btn">Create Bambi bambi</a>
    </div>

    <h2 class="section-title">Explore Bambi bambis</h2>

    <div class="bambi-grid">
      <% if (locals.bambis && bambis.length > 0) { %>
        <% bambis.forEach(bambi => { %>
          <div class="bambi-card">
            <div class="bambi-avatar">
              <img src="<%= bambi.avatar || '/gif/default-avatar.gif' %>" alt="<%= bambi.displayName || bambi.username %>">
              <% if (bambi.updatedAt) { %>
                <% 
                  const now = new Date();
                  const lastActive = new Date(bambi.updatedAt);
                  const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                  const diffHours = Math.floor(diffMinutes / 60);
                  const diffDays = Math.floor(diffHours / 24);
                  
                  let activityClass = '';
                  if (diffMinutes < 10) {
                    activityClass = 'online';
                  } else if (diffHours < 1) {
                    activityClass = 'recent';
                  }
                %>
                
                <div class="activity-indicator <%= activityClass %>" title="<%= 
                  diffMinutes < 10 ? 'Online now' : 
                  diffMinutes < 60 ? `Active ${diffMinutes} minutes ago` :
                  diffHours < 24 ? `Active ${diffHours} hours ago` :
                  `Active ${diffDays} days ago`
                %>"></div>
              <% } %>
            </div>
            <div class="bambi-info">
              <h3><%= bambi.displayName || bambi.username %></h3>
              <p class="bambi-about"><%= bambi.about || 'No information provided' %></p>
              <a href="/bambi/<%= bambi.username %>" class="view-bambi-btn">View bambi</a>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="no-bambis">
          <p>No bambi bambis found</p>
          <a href="/bambis/new" class="create-bambi-btn">Create Bambi bambi</a>
        </div>
      <% } %>
    </div>
    
    <!-- Update pagination links -->
    <% if (locals.pagination && pagination.total > 1) { %>
      <div class="bambi-pagination">
        <% 
          const searchParam = typeof search !== 'undefined' && search ? `&search=${encodeURIComponent(search)}` : '';
          const sortParam = typeof sort !== 'undefined' ? `&sort=${sort}` : '';
          const queryParams = `${searchParam}${sortParam}`;
        %>
        
        <% if (pagination.hasPrev) { %>
          <a href="/bambis?page=<%= pagination.current - 1 %><%= queryParams %>" class="pagination-btn prev">
            <span class="pagination-icon">‚óÄ</span> Previous
          </a>
        <% } else { %>
          <span class="pagination-btn disabled">
            <span class="pagination-icon">‚óÄ</span> Previous
          </span>
        <% } %>
        
        <div class="pagination-numbers">
          <% 
            const startPage = Math.max(1, pagination.current - 2);
            const endPage = Math.min(pagination.total, pagination.current + 2);
          %>
          
          <% if (startPage > 1) { %>
            <a href="/bambis?page=1<%= queryParams %>" class="pagination-number">1</a>
            <% if (startPage > 2) { %>
              <span class="pagination-ellipsis">...</span>
            <% } %>
          <% } %>
          
          <% for (let i = startPage; i <= endPage; i++) { %>
            <% if (i === pagination.current) { %>
              <span class="pagination-number active"><%= i %></span>
            <% } else { %>
              <a href="/bambis?page=<%= i %><%= queryParams %>" class="pagination-number"><%= i %></a>
            <% } %>
          <% } %>
          
          <% if (endPage < pagination.total) { %>
            <% if (endPage < pagination.total - 1) { %>
              <span class="pagination-ellipsis">...</span>
            <% } %>
            <a href="/bambis?page=<%= pagination.total %><%= queryParams %>" class="pagination-number"><%= pagination.total %></a>
          <% } %>
        </div>
        
        <% if (pagination.hasNext) { %>
          <a href="/bambis?page=<%= pagination.current + 1 %><%= queryParams %>" class="pagination-btn next">
            Next <span class="pagination-icon">‚ñ∂</span>
          </a>
        <% } else { %>
          <span class="pagination-btn disabled">
            Next <span class="pagination-icon">‚ñ∂</span>
          </span>
        <% } %>
      </div>
    <% } %>
    
  </div>

  <%- include('./partials/footer.ejs', { footer: typeof footer !== 'undefined' ? footer : {} }) %>
  
  <script src="/socket.io/socket.io.js"></script>
  <!-- Add any page-specific scripts that were previously in the scripts array -->
  
  <!-- Add this CSS for the activity indicators -->
  <style>
    .bambi-avatar {
      position: relative;
    }
    
    .activity-indicator {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #888;
      border: 2px solid rgba(0,0,0,0.3);
    }
    
    .activity-indicator.online {
      background: #00ff00;
      box-shadow: 0 0 8px #00ff00;
      animation: pulse 2s infinite;
    }
    
    .activity-indicator.recent {
      background: #ffcc00;
      box-shadow: 0 0 5px #ffcc00;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
    }

    .bambi-search {
      margin: 1rem 0;
      max-width: 500px;
      width: 100%;
    }
    
    .search-form {
      display: flex;
      border-radius: 20px;
      overflow: hidden;
      border: 2px solid rgba(255, 100, 255, 0.3);
      background: rgba(20, 20, 30, 0.6);
    }
    
    .search-input {
      flex: 1;
      padding: 10px 15px;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 16px;
    }
    
    .search-input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(255, 100, 255, 0.5) inset;
    }
    
    .search-button {
      background: rgba(255, 100, 255, 0.2);
      border: none;
      padding: 0 15px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .search-button:hover {
      background: rgba(255, 100, 255, 0.4);
    }

    .bambi-sort {
      display: flex;
      align-items: center;
      margin: 1rem 0;
      gap: 10px;
    }
    
    .sort-label {
      font-size: 14px;
      opacity: 0.7;
    }
    
    .sort-options {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .sort-option {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 14px;
      background: rgba(255, 100, 255, 0.1);
      color: #ff80ff;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .sort-option:hover {
      background: rgba(255, 100, 255, 0.2);
      box-shadow: 0 0 5px rgba(255, 100, 255, 0.4);
    }
    
    .sort-option.active {
      background: rgba(255, 100, 255, 0.3);
      box-shadow: 0 0 8px rgba(255, 100, 255, 0.6);
    }
  </style>
</body>
</html>