<% 
// Default values if profile is not provided
const userLevel = profile ? profile.level || 0 : 0;
const userXp = profile ? profile.xp || 0 : 0;

// Define XP requirements for each level
const xpRequirements = [1000, 2500, 7500, 17000, 42000];

// Calculate next level XP requirement
const getNextLevelXP = (level) => {
  if (level < xpRequirements.length) {
    return xpRequirements[level];
  } else {
    return null;
  }
};

const nextLevelXP = userLevel < xpRequirements.length ? getNextLevelXP(userLevel) : null;
const systemControls = profile && profile.systemControls ? profile.systemControls : {};
%>

<div class="system-controls">
  <!-- Control buttons section -->
  <div id="buttons" class="control-buttons">
    <!-- Show triggers button only if level â‰¥ 1 -->
    <% if (userLevel >= 1) { %>
      <button id="triggers-btn" class="control-btn active" data-target="trigger-panel">Triggers</button>
    <% } else { %>
      <button class="control-btn disabled" title="Reach Level 1 to unlock">Triggers ðŸ”’</button>
    <% } %>
    
    <!-- Show collar feature if user level â‰¥ 2 -->
    <% if (userLevel >= 2) { %>
      <button id="collar-btn" class="control-btn" data-target="collar-panel">Collar</button>
    <% } else { %>
      <button class="control-btn disabled" title="Reach Level 2 to unlock">Collar ðŸ”’</button>
    <% } %>
    
    <!-- Show session history feature if user level â‰¥ 3 -->
    <% if (userLevel >= 3) { %>
      <button id="session-history-btn" class="control-btn" data-target="session-history-panel">Session History</button>
    <% } else { %>
      <button class="control-btn disabled" title="Reach Level 3 to unlock">Session History ðŸ”’</button>
    <% } %>
    
    <!-- Show spirals feature if user level â‰¥ 4 -->
    <% if (userLevel >= 4) { %>
      <button id="spirals-btn" class="control-btn" data-target="spirals-panel">Spirals</button>
    <% } else { %>
      <button class="control-btn disabled" title="Reach Level 4 to unlock">Spirals ðŸ”’</button>
    <% } %>
    
    <!-- Show hypnosis feature if user level â‰¥ 5 -->
    <% if (userLevel >= 5) { %>
      <button id="hypnosis-btn" class="control-btn" data-target="hypnosis-panel">Hypnosis</button>
    <% } else { %>
      <button class="control-btn disabled" title="Reach Level 5 to unlock">Hypnosis ðŸ”’</button>
    <% } %>
    
    <!-- Show audios feature if user level â‰¥ 6 -->
    <% if (userLevel >= 6) { %>
      <button id="audios-btn" class="control-btn" data-target="audios-panel">Audios</button>
    <% } else { %>
      <button class="control-btn disabled" title="Reach Level 6 to unlock">Audios ðŸ”’</button>
    <% } %>

    <!-- Show brainwave feature if user level â‰¥ 4 -->
<% if (userLevel >= 7) { %>
  <button id="brainwave-btn" class="control-btn" data-target="brainwave-panel">Brainwaves</button>
<% } else { %>
  <button class="control-btn disabled" title="Reach Level 4 to unlock">Brainwaves ðŸ”’</button>
<% } %>
  </div>

  <!-- Control panels section -->
  <div id="console" class="control-panels">
    <% if (userLevel >= 1) { %>
      <!-- Trigger panel -->
      <div id="trigger-panel" class="control-panel active">
        <h3>Trigger Toggles</h3>
        <div class="trigger-actions">
          <button id="activate-all" class="secondary-btn">Toggle All</button>
          <button id="play-triggers" class="btn btn-accent">
            <i class="fas fa-play"></i> Play Triggers
          </button>
        </div>
        <div id="trigger-list" class="trigger-grid"></div>
      </div>
      
      <% if (userLevel >= 2) { %>
        <!-- Collar panel -->
        <div id="collar-panel" class="control-panel">
          <h3>Collar Control</h3>
          <div id="collar-form-inputs">
            <div class="collar-toggle">
              <input type="checkbox" id="collar-enable" <%= systemControls.collarEnabled ? 'checked' : '' %>>
              <label for="collar-enable">Enable Collar</label>
            </div>
            <textarea id="textarea-collar" placeholder="Enter collar instructions..."><%= systemControls.collarText || '' %></textarea>
            <button id="save-collar" class="save-btn">Save Collar Settings</button>
          </div>
          <div class="collar-messages"></div>
        </div>
      <% } %>
      
      <% if (userLevel >= 3) { %>
        <!-- Session history panel -->
        <div id="session-history-panel" class="control-panel">
          <h3>Session History</h3>
          
          <div id="session-history-status" class="session-history-status">
            Click "Load History" to view your sessions
          </div>
          
          <div class="session-select-container" style="display: none">
            <select id="session-select">
              <option value="">Select a session...</option>
            </select>
            <div id="active-session-info" class="active-session-info" style="display: none">
              <span class="info-label">Active Session:</span>
              <span id="active-session-date">None</span>
            </div>
          </div>
          
          <div class="session-stats-container" style="display: none">
            <div class="session-stat">
              <div class="stat-value" id="session-count">0</div>
              <div class="stat-label">Sessions</div>
            </div>
            <div class="session-stat">
              <div class="stat-value" id="message-count">0</div>
              <div class="stat-label">Messages</div>
            </div>
            <div class="session-stat">
              <div class="stat-value" id="word-count">0</div>
              <div class="stat-label">Words</div>
            </div>
          </div>
          
          <div class="session-history-actions">
            <button id="load-history-btn" class="control-btn">Load History</button>
            <button id="replay-history-btn" class="control-btn" disabled>Replay Random</button>
          </div>
        </div>
      <% } %>
      
      <% if (userLevel >= 4) { %>
        <!-- Spirals panel -->
        <div id="spirals-panel" class="control-panel">
          <h3>Spirals Settings</h3>
          <div class="spirals-toggle">
            <input type="checkbox" id="spirals-enable" <%= systemControls.spiralsEnabled ? 'checked' : '' %>>
            <label for="spirals-enable">Enable Spirals</label>
          </div>
          
          <div class="spirals-controls">
            <div class="spiral-control-group">
              <label>Purple Spiral Width:</label>
              <div class="slider-container">
                <input type="range" id="spiral1-width" min="1" max="10" value="<%= systemControls.spiral1Width || 5.0 %>" step="0.5" class="spiral-slider">
                <span id="spiral1-width-value"><%= systemControls.spiral1Width || 5.0 %></span>
              </div>
            </div>
            
            <div class="spiral-control-group">
              <label>Pink Spiral Width:</label>
              <div class="slider-container">
                <input type="range" id="spiral2-width" min="1" max="10" value="<%= systemControls.spiral2Width || 3.0 %>" step="0.5" class="spiral-slider">
                <span id="spiral2-width-value"><%= systemControls.spiral2Width || 3.0 %></span>
              </div>
            </div>
            
            <div class="spiral-control-group">
              <label>Purple Spiral Speed:</label>
              <div class="slider-container">
                <input type="range" id="spiral1-speed" min="5" max="40" value="<%= systemControls.spiral1Speed || 20 %>" step="1" class="spiral-slider">
                <span id="spiral1-speed-value"><%= systemControls.spiral1Speed || 20 %></span>
              </div>
            </div>
            
            <div class="spiral-control-group">
              <label>Pink Spiral Speed:</label>
              <div class="slider-container">
                <input type="range" id="spiral2-speed" min="5" max="40" value="<%= systemControls.spiral2Speed || 15 %>" step="1" class="spiral-slider">
                <span id="spiral2-speed-value"><%= systemControls.spiral2Speed || 15 %></span>
              </div>
            </div>
          </div>
          
          <div class="spirals-actions">
            <button id="save-spirals" class="save-btn">Save Spiral Settings</button>
          </div>
        </div>
      <% } %>
      
      <% if (userLevel >= 5) { %>
        <!-- Hypnosis panel -->
        <div id="hypnosis-panel" class="control-panel">
          <h3>Hypnosis Settings</h3>
          <div class="hypnosis-toggle">
            <input type="checkbox" id="hypnosis-enable" <%= systemControls.hypnosisEnabled ? 'checked' : '' %>>
            <label for="hypnosis-enable">Enable Hypnosis</label>
          </div>
          <div class="hypnosis-settings">
            <!-- Hypnosis settings would go here -->
            <p>Hypnosis settings will appear here in a future update.</p>
          </div>
        </div>
      <% } %>
      
      <% if (userLevel >= 6) { %>
        <!-- Audio panel -->
        <div id="audios-panel" class="control-panel">
          <h3>Trigger Audios</h3>
          <div class="playlist-actions">
            <button id="play-playlist" class="secondary-btn">Play Random Playlist</button>
            <div class="trigger-toggle-item">
              <input type="checkbox" id="loop-toggle" class="toggle-input">
              <label for="loop-toggle" class="toggle-label">Continuous Loop</label>
            </div>
          </div>
          
          <div class="audio-controls">
            <div class="audio-speed-control">
              <label for="loop-speed">Speed:</label>
              <input type="range" id="loop-speed" min="1" max="10" value="5" class="speed-slider">
              <span id="speed-value">Normal</span>
            </div>
            
            <div class="audio-volume-control">
              <label for="loop-volume">Volume:</label>
              <input type="range" id="loop-volume" min="0" max="10" value="8" class="volume-slider">
              <span id="volume-value">80%</span>
            </div>
          </div>
        </div>
      <% } %>
        <% if (userLevel >= 7) { %>
  <!-- Brainwave panel -->
  <div id="brainwave-panel" class="control-panel">
    <h3>Binaural Brainwaves</h3>
    <div class="brainwave-toggle">
      <input type="checkbox" id="brainwave-enable" <%= systemControls.brainwaveEnabled ? 'checked' : '' %>>
      <label for="brainwave-enable">Enable Binaural Beats</label>
    </div>
    
    <div class="brainwave-controls">
      <div class="brainwave-mode-selector">
        <label for="brainwave-mode">Brainwave Mode:</label>
        <select id="brainwave-mode" class="brainwave-select">
          <option value="alpha" <%= systemControls.brainwaveMode === 'alpha' ? 'selected' : '' %>>Alpha (8-14Hz) - Relaxed Focus</option>
          <option value="theta" <%= systemControls.brainwaveMode === 'theta' ? 'selected' : '' %>>Theta (4-8Hz) - Deep Trance</option>
          <option value="delta" <%= systemControls.brainwaveMode === 'delta' ? 'selected' : '' %>>Delta (1-4Hz) - Sleep State</option>
          <option value="beta" <%= systemControls.brainwaveMode === 'beta' ? 'selected' : '' %>>Beta (14-30Hz) - Alert State</option>
          <option value="custom" <%= systemControls.brainwaveMode === 'custom' ? 'selected' : '' %>>Custom Frequency</option>
        </select>
      </div>
      
      <div id="custom-freq-container" class="brainwave-control-group" style="<%= systemControls.brainwaveMode === 'custom' ? '' : 'display: none;' %>">
        <label>Custom Frequency (Hz):</label>
        <div class="slider-container">
          <input type="range" id="custom-frequency" min="1" max="30" value="<%= systemControls.customFrequency || 10 %>" step="0.5" class="brainwave-slider">
          <span id="custom-frequency-value"><%= systemControls.customFrequency || 10 %> Hz</span>
        </div>
      </div>
      
      <div class="brainwave-control-group">
        <label>Carrier Tone (Hz):</label>
        <div class="slider-container">
          <input type="range" id="carrier-frequency" min="200" max="800" value="<%= systemControls.carrierFrequency || 400 %>" step="10" class="brainwave-slider">
          <span id="carrier-frequency-value"><%= systemControls.carrierFrequency || 400 %> Hz</span>
        </div>
      </div>
      
      <div class="brainwave-control-group">
        <label>Volume:</label>
        <div class="slider-container">
          <input type="range" id="brainwave-volume" min="0" max="100" value="<%= systemControls.brainwaveVolume || 50 %>" step="5" class="brainwave-slider">
          <span id="brainwave-volume-value"><%= systemControls.brainwaveVolume || 50 %>%</span>
        </div>
      </div>
    </div>
    
    <div class="brainwave-description">
      <p id="frequency-description">Alpha waves (8-14Hz) promote relaxed focus and are ideal for gentle trance states.</p>
    </div>
    
    <div class="brainwave-actions">
      <button id="play-brainwave" class="control-btn btn-accent">
        <i class="fas fa-play"></i> Start Binaural Beat
      </button>
      <button id="stop-brainwave" class="control-btn" disabled>
        <i class="fas fa-stop"></i> Stop
      </button>
      <button id="save-brainwave" class="save-btn">Save Settings</button>
    </div>
  </div>
<% } %>

    <% } else { %>
      <div class="locked-features-message">
        <p>ðŸ”’ Reach Level 1 to unlock trigger controls!</p>
        <p>Keep chatting with Bambi to earn XP and level up.</p>
      </div>
    <% } %>
  </div>

  <!-- XP progress bar -->
  <% if (userXp !== undefined) { %>
    <div class="xp-progress-container">
      <div class="xp-progress-label" id="xp-progress-label">
        <% if (userLevel < xpRequirements.length) { %>
          Level <%= userLevel %> â€¢ <%= userXp %> XP / <%= nextLevelXP %> XP
        <% } else { %>
          Level <%= userLevel %> â€¢ <%= userXp %> XP (MAX LEVEL)
        <% } %>
      </div>
      <div class="xp-progress-bar">
        <% if (userLevel < xpRequirements.length) { %>
          <div class="xp-progress-fill" id="xp-progress-fill" style="width: <%= Math.min(100, userXp / Math.max(1, nextLevelXP) * 100) %>%"></div>
        <% } else { %>
          <div class="xp-progress-fill" id="xp-progress-fill" style="width: 100%"></div>
        <% } %>
      </div>
    </div>
  <% } %>
</div>

<style>
  /* Control buttons styling */
  .control-btn.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: #444;
    color: #aaa;
  }
  
  /* XP progress bar styling */
  .xp-progress-container {
    margin-top: 20px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 5px;
  }
  
  .xp-progress-label {
    margin-bottom: 5px;
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.7);
    text-align: center;
  }
  
  .xp-progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }
  
  .xp-progress-fill {
    height: 100%;
    background: linear-gradient(to right, #00ffff, #ff00ff);
    border-radius: 4px;
    transition: width 0.5s ease-in-out;
  }
  
  /* Audio controls styling */
  .audio-controls {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .audio-speed-control, .audio-volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .speed-slider, .volume-slider {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    outline: none;
  }

  .speed-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ff00ff;
    cursor: pointer;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #00ffff;
    cursor: pointer;
  }

  .speed-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ff00ff;
    cursor: pointer;
  }

  .volume-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #00ffff;
    cursor: pointer;
  }

  #speed-value, #volume-value {
    min-width: 60px;
    text-align: center;
    font-size: 0.9em;
  }

  #speed-value {
    color: #ff00ff;
  }

  #volume-value {
    color: #00ffff;
  }

  /* Session controls styling */
  .session-stats-container {
    display: flex;
    justify-content: space-around;
    margin: 15px 0;
    background-color: rgba(10, 38, 38, 0.4);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid var(--tertiary-alt);
  }

  .session-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 5px 15px;
    text-align: center;
  }

  .session-stat .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--tertiary-alt);
    text-shadow: 0 0 5px var(--tertiary-color);
  }

  .session-stat .stat-label {
    font-size: 0.8rem;
    color: var(--primary-alt);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .session-history-status {
    text-align: center;
    padding: 10px;
    margin: 10px 0;
    color: var(--primary-alt);
    font-style: italic;
  }

  .session-history-status.error {
    color: var(--error);
    border-left: 3px solid var(--error);
    background-color: rgba(255, 0, 0, 0.1);
  }

  .session-history-status.success {
    color: var(--tertiary-alt);
    border-left: 3px solid var(--tertiary-alt);
    background-color: rgba(23, 219, 216, 0.1);
  }

  .session-history-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 15px;
  }

  .active-session-info {
    margin-top: 8px;
    padding: 6px 10px;
    background-color: rgba(0, 255, 255, 0.1);
    border-left: 3px solid var(--tertiary-alt);
    font-size: 0.85rem;
    color: var(--primary-alt);
  }

  .info-label {
    font-weight: bold;
    margin-right: 5px;
    color: var(--tertiary-alt);
  }

  /* Spirals controls styling */
  .spirals-controls {
    margin: 15px 0;
    background-color: rgba(10, 38, 38, 0.4);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid var(--tertiary-alt);
  }

  .spiral-control-group {
    margin-bottom: 12px;
  }

  .spiral-control-group label {
    display: block;
    margin-bottom: 5px;
    color: var(--tertiary-alt);
    font-size: 0.9rem;
  }

  .slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .spiral-slider {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    outline: none;
  }

  .spiral-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ff00ff;
    cursor: pointer;
  }

  .spiral-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #ff00ff;
    cursor: pointer;
  }

  /* Brainwave controls styling */
.brainwave-controls {
  margin: 15px 0;
  background-color: rgba(10, 38, 38, 0.4);
  border-radius: 8px;
  padding: 15px;
  border: 1px solid var(--tertiary-alt);
}

.brainwave-mode-selector {
  margin-bottom: 15px;
}

.brainwave-select {
  width: 100%;
  padding: 8px;
  background-color: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--tertiary-color);
  color: var(--primary-alt);
  border-radius: 4px;
  margin-top: 5px;
}

.brainwave-control-group {
  margin-bottom: 12px;
}

.brainwave-control-group label {
  display: block;
  margin-bottom: 5px;
  color: var(--tertiary-alt);
  font-size: 0.9rem;
}

.brainwave-description {
  background-color: rgba(255, 0, 255, 0.1);
  border-left: 3px solid var(--tertiary-color);
  padding: 10px;
  margin: 15px 0;
  font-size: 0.9em;
  color: var(--primary-alt);
}

.brainwave-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.brainwave-actions button {
  flex: 1;
}

.brainwave-slider {
  flex: 1;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  outline: none;
}

.brainwave-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--tertiary-color);
  cursor: pointer;
}

.brainwave-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--tertiary-color);
  cursor: pointer;
}

.btn-accent {
  background-color: var(--tertiary-color);
  color: var(--dark-bg);
}

.btn-accent:hover {
  background-color: var(--tertiary-alt);
}
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Store XP requirements globally
    window.xpRequirements = [100, 250, 450, 700, 1200];
    
    // Tab navigation system
    const controlButtons = document.querySelectorAll('.control-btn:not(.disabled)');
    
    controlButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        
        // Toggle active states
        controlButtons.forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.control-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        
        this.classList.add('active');
        
        // Show target panel
        const targetPanel = document.getElementById(targetId);
        if (targetPanel) targetPanel.classList.add('active');
      });
    });
    
    // Set initial volume and speed from localStorage
    const volumeSlider = document.getElementById('loop-volume');
    const volumeValue = document.getElementById('volume-value');
    if (volumeSlider && volumeValue) {
      const storedVolume = localStorage.getItem('bambiAudioVolume');
      if (storedVolume !== null) {
        const volume = parseFloat(storedVolume);
        volumeSlider.value = volume * 10;
        volumeValue.textContent = Math.round(volume * 100) + '%';
      }
    }
    
    const speedSlider = document.getElementById('loop-speed');
    const speedValue = document.getElementById('speed-value');
    if (speedSlider && speedValue) {
      const storedSpeed = localStorage.getItem('bambiAudioSpeed');
      if (storedSpeed !== null) {
        speedSlider.value = storedSpeed;
        updateSpeedLabel(storedSpeed, speedValue);
      }
    }
    
    // Helper function for speed label
    function updateSpeedLabel(value, element) {
      if (!element) return;
      
      const speedVal = parseInt(value);
      if (speedVal === 5) {
        element.textContent = 'Normal';
      } else if (speedVal < 5) {
        element.textContent = 'Slower ' + (5 - speedVal) + 'x';
      } else {
        element.textContent = 'Faster ' + (speedVal - 5) + 'x';
      }
    }
    
    // Watch for trigger list changes to avoid duplicates
    const triggerList = document.getElementById('trigger-list');
    if (triggerList) {
      const observer = new MutationObserver(function(mutations) {
        if (mutations.some(m => m.addedNodes.length > 0)) {
          document.dispatchEvent(new CustomEvent('trigger-controls-loaded'));
          observer.disconnect();
        }
      });
      
      observer.observe(triggerList, { childList: true });
    }
  });
</script>

<!-- Load modular system control scripts -->
<script src="/js/xp-notification.js"></script>
<script src="/js/xp-progress.js"></script>
<script src="/js/collar-controls.js"></script>
<script src="/js/trigger-controls.js"></script>
<script src="/js/bambi-sessions.js"></script>
<script src="/js/system-controls.js"></script>