<% if (locals.bambi) { %>
  <!-- SINGLE PROFILE VIEW -->
  <a href="/bambis" class="back-to-profiles"><i class="fas fa-arrow-left"></i> Back to Profiles</a>
  
  <div class="profile-container modern">
    <!-- Cover banner with gradient based on user's theme -->
    <div class="profile-banner" style="background: linear-gradient(135deg, <%= bambi.profileTheme?.primaryColor || '#fa81ff' %> 0%, <%= bambi.profileTheme?.secondaryColor || '#ff4fa2' %> 100%);">
      <div class="banner-overlay"></div>
      <div class="banner-actions">
        <button id="shareProfileBtn" class="share-button" aria-label="Share profile">
          <i class="fas fa-share-alt"></i> Share
        </button>
      </div>
    </div>
    
    <div class="profile-content">
      <!-- Profile header with avatar and identity -->
      <div class="profile-header modern">
        <div class="avatar-container">
          <img src="<%= bambi.profilePictureUrl || '/images/default-profile.png' %>" alt="<%= bambi.displayName || bambi.username %>" class="profile-avatar">
          <% if (bambi.isVerified) { %>
            <div class="verified-badge" title="Verified Bambi">
              <i class="fas fa-check-circle"></i>
            </div>
          <% } %>
        </div>
        
        <div class="profile-identity">
          <h1 class="profile-name"><%= bambi.displayName || bambi.username %></h1>
          <div class="profile-username">@<%= bambi.username %></div>
          <div class="custom-url">
            <i class="fas fa-link"></i> bambisleep.chat/bambis/<%= bambi.username %>
          </div>
        </div>
      </div>
      
      <!-- Stats cards with refined design -->
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-signal"></i></div>
          <div class="stat-value"><%= bambi.level || 0 %></div>
          <div class="stat-label">Level</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-tag"></i></div>
          <div class="stat-value"><%= bambi.triggers ? bambi.triggers.length : 0 %></div>
          <div class="stat-label">Triggers</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-file-audio"></i></div>
          <div class="stat-value"><%= bambi.favoriteFiles ? bambi.favoriteFiles.length : 0 %></div>
          <div class="stat-label">Favorite Files</div>
        </div>
        
        <div class="stat-card heart-stat">
          <div class="stat-icon"><i class="fas fa-heart"></i></div>
          <div class="stat-value">
            <span id="heartCount"><%= bambi.hearts ? bambi.hearts.count : 0 %></span>
          </div>
          <div class="stat-label">Hearts</div>
          <button id="heartButton" class="heart-button <%= bambi.hearts?.userHasHearted ? 'active' : '' %>" aria-label="Give heart">
            <i class="fas fa-heart"></i>
          </button>
        </div>
      </div>
      
      <!-- Main content with enhanced tabs -->
      <div class="profile-tabs">
        <div class="tabs-navigation">
          <button class="tab-button active" data-tab="about">
            <i class="fas fa-user"></i> About
          </button>
          <button class="tab-button" data-tab="triggers">
            <i class="fas fa-bolt"></i> Triggers
          </button>
          <button class="tab-button" data-tab="activity">
            <i class="fas fa-history"></i> Activity
          </button>
          <button class="tab-button" data-tab="files">
            <i class="fas fa-headphones"></i> Files
          </button>
        </div>
        
        <!-- Tab contents with enhanced styling -->
        <div class="tab-content active" id="about-tab">
          <h3>About</h3>
          <div class="profile-description">
            <%= bambi.description || 'No description provided' %>
          </div>
          
          <% if (bambi.socialLinks && bambi.socialLinks.length > 0) { %>
            <div class="social-links">
              <h4>Connect with <%= bambi.displayName || bambi.username %></h4>
              <div class="links-container">
                <% bambi.socialLinks.forEach(link => { %>
                  <a href="<%= link.url %>" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="<%= link.platform %>">
                    <i class="fab fa-<%= link.platform.toLowerCase() %>"></i>
                  </a>
                <% }) %>
              </div>
            </div>
          <% } %>
          
          <% if (bambi.joinDate) { %>
            <div class="join-date">
              <i class="fas fa-calendar-alt"></i> Joined <%= new Date(bambi.joinDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
            </div>
          <% } %>
          
          <% if (bambi.badges && bambi.badges.length > 0) { %>
            <div class="badges-section">
              <h4>Achievements</h4>
              <div class="badges-container">
                <% bambi.badges.forEach(badge => { %>
                  <div class="badge-item" title="<%= badge.description %>">
                    <div class="badge-icon">
                      <i class="<%= badge.icon %>"></i>
                    </div>
                    <div class="badge-name"><%= badge.name %></div>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>
        </div>
        
        <div class="tab-content" id="triggers-tab">
          <h3 class="triggers-title">Triggers</h3>
          
          <div class="trigger-tags">
            <% if (bambi.triggers && bambi.triggers.length > 0) { %>
              <% bambi.triggers.forEach(trigger => { %>
                <div class="trigger-tag">
                  <i class="fas fa-bolt trigger-icon"></i>
                  <%= trigger %>
                </div>
              <% }) %>
            <% } else { %>
              <p class="empty-state">No triggers added yet</p>
            <% } %>
          </div>
          
          <% if (bambi.triggerCategories && bambi.triggerCategories.length > 0) { %>
            <div class="trigger-categories">
              <h4>Trigger Categories</h4>
              <div class="category-list">
                <% bambi.triggerCategories.forEach(category => { %>
                  <div class="category-item">
                    <span class="category-name"><%= category.name %></span>
                    <span class="category-count"><%= category.count %></span>
                  </div>
                <% }) %>
              </div>
            </div>
          <% } %>
        </div>
        
        <div class="tab-content" id="activity-tab">
          <h3>Recent Activity</h3>
          <div class="activity-feed">
            <% if (bambi.activities && bambi.activities.length > 0) { %>
              <% bambi.activities.slice(0, 5).forEach(activity => { %>
                <div class="activity-item">
                  <div class="activity-icon">
                    <% if (activity.type === 'file') { %>
                      <i class="fas fa-file-audio"></i>
                    <% } else if (activity.type === 'level') { %>
                      <i class="fas fa-arrow-up"></i>
                    <% } else if (activity.type === 'badge') { %>
                      <i class="fas fa-award"></i>
                    <% } else if (activity.type === 'heart') { %>
                      <i class="fas fa-heart"></i>
                    <% } else { %>
                      <i class="fas fa-star"></i>
                    <% } %>
                  </div>
                  <div class="activity-details">
                    <p><%= activity.description %></p>
                    <div class="activity-meta">
                      <small><i class="far fa-clock"></i> <%= new Date(activity.timestamp).toLocaleString() %></small>
                      <% if (activity.linkUrl) { %>
                        <a href="<%= activity.linkUrl %>" class="activity-link">View</a>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }) %>
              
              <% if (bambi.activities.length > 5) { %>
                <button class="load-more-btn">Load More Activity</button>
              <% } %>
            <% } else { %>
              <div class="empty-state">
                <i class="fas fa-history empty-icon"></i>
                <p>No recent activity</p>
              </div>
            <% } %>
          </div>
        </div>
        
        <div class="tab-content" id="files-tab">
          <h3>Favorite Files</h3>
          <div class="files-grid">
            <% if (bambi.favoriteFiles && bambi.favoriteFiles.length > 0) { %>
              <% bambi.favoriteFiles.forEach(file => { %>
                <div class="file-card">
                  <div class="file-icon">
                    <i class="fas fa-file-audio"></i>
                  </div>
                  <div class="file-details">
                    <h4><%= file.title %></h4>
                    <p><%= file.description || 'No description' %></p>
                    <div class="file-meta">
                      <span><i class="fas fa-play"></i> <%= file.plays || 0 %></span>
                      <span><i class="fas fa-heart"></i> <%= file.hearts || 0 %></span>
                      <% if (file.duration) { %>
                        <span><i class="fas fa-clock"></i> <%= file.duration %></span>
                      <% } %>
                    </div>
                  </div>
                  <div class="file-actions">
                    <a href="/files/<%= file.id %>" class="file-action-btn" aria-label="Play file">
                      <i class="fas fa-play"></i>
                    </a>
                    <button class="file-action-btn add-to-playlist" data-file-id="<%= file.id %>" aria-label="Add to playlist">
                      <i class="fas fa-plus"></i>
                    </button>
                    <button class="file-action-btn file-heart <%= file.userHasHearted ? 'active' : '' %>" data-file-id="<%= file.id %>" aria-label="Heart file">
                      <i class="fas fa-heart"></i>
                    </button>
                  </div>
                </div>
              <% }) %>
              
              <% if (bambi.favoriteFiles.length > 6) { %>
                <button class="load-more-btn">See All Files</button>
              <% } %>
            <% } else { %>
              <div class="empty-state">
                <i class="fas fa-file-audio empty-icon"></i>
                <p>No favorite files yet</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
      
      <!-- User actions with enhanced buttons -->
      <div class="profile-actions">
        <% if (locals.isOwnProfile) { %>
          <button id="editProfileBtn" class="edit-profile-btn action-btn primary">
            <i class="fas fa-edit"></i> Edit Profile
          </button>
        <% } else { %>
          <button id="followBtn" class="follow-btn action-btn primary <%= bambi.isFollowedByUser ? 'following' : '' %>">
            <i class="fas <%= bambi.isFollowedByUser ? 'fa-user-check' : 'fa-user-plus' %>"></i> 
            <%= bambi.isFollowedByUser ? 'Following' : 'Follow' %>
          </button>
          <button id="messageBtn" class="message-btn action-btn secondary">
            <i class="fas fa-comment"></i> Message
          </button>
        <% } %>
      </div>
    </div>
    
    <!-- Modern Edit Profile Form -->
    <div id="editForm" class="edit-form">
      <div class="edit-form-header">
        <h2>Edit Your Profile</h2>
        <button id="closeEditForm" class="close-form-btn" aria-label="Close form"><i class="fas fa-times"></i></button>
      </div>
      
      <form id="profileEditForm">
        <div class="form-sections">
          <div class="form-section">
            <h3 class="section-title">Basic Information</h3>
            <div class="form-group">
              <label for="displayNameEdit">Display Name</label>
              <input type="text" id="displayNameEdit" name="displayName" value="<%= bambi.displayName || '' %>" placeholder="Your display name">
            </div>
            
            <div class="form-group">
              <label for="descriptionEdit">About You</label>
              <textarea id="descriptionEdit" name="description" rows="4" placeholder="Tell us about yourself..."><%= bambi.description || '' %></textarea>
              <div class="char-counter"><span id="descriptionCharCount">0</span>/500</div>
            </div>
            
            <div class="form-group">
              <label for="profilePictureEdit">Profile Picture</label>
              <div class="profile-picture-upload">
                <div class="current-picture">
                  <img src="<%= bambi.profilePictureUrl || '/images/default-profile.png' %>" alt="Current profile picture" id="currentProfilePic">
                </div>
                <div class="upload-controls">
                  <input type="file" id="profilePictureEdit" name="profilePicture" accept="image/*">
                  <button type="button" class="upload-btn" id="triggerFileUpload">Choose File</button>
                  <span id="selectedFileName">No file selected</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <h3 class="section-title">Triggers</h3>
            <div class="form-group triggers-group">
              <div id="triggersList" class="triggers-input">
                <% if (bambi.triggers && bambi.triggers.length > 0) { %>
                  <% bambi.triggers.forEach(trigger => { %>
                    <div class="trigger-pill" data-value="<%= trigger %>">
                      <%= trigger %><span class="remove-trigger">×</span>
                    </div>
                  <% }) %>
                <% } %>
              </div>
              <div class="add-trigger-input">
                <input type="text" id="newTrigger" placeholder="Type a trigger and press Enter">
                <button type="button" id="addTriggerBtn" class="add-trigger-btn">Add</button>
              </div>
              <div class="triggers-info">Add words or phrases that trigger your bambi state</div>
            </div>
          </div>
          
          <div class="form-section">
            <h3 class="section-title">Profile Theme</h3>
            <div class="theme-customizer">
              <div class="color-pickers">
                <div class="color-picker">
                  <label for="primaryColor">Primary Color</label>
                  <input type="color" id="primaryColor" name="primaryColor" value="<%= bambi.profileTheme?.primaryColor || '#fa81ff' %>">
                </div>
                
                <div class="color-picker">
                  <label for="secondaryColor">Secondary Color</label>
                  <input type="color" id="secondaryColor" name="secondaryColor" value="<%= bambi.profileTheme?.secondaryColor || '#ff4fa2' %>">
                </div>
                
                <div class="color-picker">
                  <label for="textColor">Text Color</label>
                  <input type="color" id="textColor" name="textColor" value="<%= bambi.profileTheme?.textColor || '#ffffff' %>">
                </div>
              </div>
              
              <div class="preview-box" id="themePreview" style="background: linear-gradient(135deg, <%= bambi.profileTheme?.primaryColor || '#fa81ff' %> 0%, <%= bambi.profileTheme?.secondaryColor || '#ff4fa2' %> 100%);">
                <span style="color: <%= bambi.profileTheme?.textColor || '#ffffff' %>">Theme Preview</span>
              </div>
              
              <div class="theme-presets">
                <button type="button" class="theme-preset" data-primary="#fa81ff" data-secondary="#ff4fa2" data-text="#ffffff">
                  Bambi Pink
                </button>
                <button type="button" class="theme-preset" data-primary="#55cdfc" data-secondary="#7b5aad" data-text="#ffffff">
                  Trans Pride
                </button>
                <button type="button" class="theme-preset" data-primary="#ff69b4" data-secondary="#ff8c00" data-text="#ffffff">
                  Sissy Dream
                </button>
                <button type="button" class="theme-preset" data-primary="#9932cc" data-secondary="#4b0082" data-text="#ffffff">
                  Deep Trance
                </button>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <h3 class="section-title">Social Links</h3>
            <div class="social-links-editor">
              <div id="socialLinksList">
                <% if (bambi.socialLinks && bambi.socialLinks.length > 0) { %>
                  <% bambi.socialLinks.forEach((link, index) => { %>
                    <div class="social-link-item" data-index="<%= index %>">
                      <select name="socialPlatform" class="social-platform-select">
                        <option value="twitter" <%= link.platform === 'twitter' ? 'selected' : '' %>>Twitter</option>
                        <option value="instagram" <%= link.platform === 'instagram' ? 'selected' : '' %>>Instagram</option>
                        <option value="discord" <%= link.platform === 'discord' ? 'selected' : '' %>>Discord</option>
                        <option value="reddit" <%= link.platform === 'reddit' ? 'selected' : '' %>>Reddit</option>
                        <option value="other" <%= !['twitter', 'instagram', 'discord', 'reddit'].includes(link.platform) ? 'selected' : '' %>>Other</option>
                      </select>
                      <input type="text" name="socialUrl" value="<%= link.url %>" placeholder="https://">
                      <button type="button" class="remove-social-btn">×</button>
                    </div>
                  <% }) %>
                <% } %>
              </div>
              <button type="button" id="addSocialLinkBtn" class="add-social-btn">
                <i class="fas fa-plus"></i> Add Social Link
              </button>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" id="cancelEditBtn" class="cancel-btn">Cancel</button>
          <button type="submit" class="save-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
<% } else { %>
  <!-- PROFILES LIST VIEW -->
  <h1>Bambi Profiles</h1>
  
  <% if (locals.error) { %>
    <div class="error-message">
      <%= error %>
    </div>
  <% } %>
  
  <div class="create-profile-section">
    <h2>Create Your Bambi Profile</h2>
    <form id="createProfileForm">
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" required minlength="3" placeholder="Your unique bambi name">
        <div class="input-info">Username must be at least 3 characters and contain only letters, numbers, and underscores</div>
      </div>
      
      <div class="form-group">
        <label for="displayName">Display Name (optional)</label>
        <input type="text" id="displayName" name="displayName" placeholder="Your display name">
        <div class="input-info">This is how your name will appear to others</div>
      </div>
      
      <div class="form-group">
        <label for="description">About You</label>
        <textarea id="description" name="description" rows="4" placeholder="Tell us about yourself..."></textarea>
        <div class="char-counter"><span id="createDescriptionCharCount">0</span>/500</div>
      </div>
      
      <button type="submit" id="createProfileBtn">Create Profile</button>
    </form>
  </div>
  
  <% if (locals.bambis && bambis.length > 0) { %>
    <div class="profiles-filter">
      <div class="filter-controls">
        <div class="search-box">
          <input type="text" id="profileSearch" placeholder="Search profiles...">
          <button id="searchBtn"><i class="fas fa-search"></i></button>
        </div>
        <div class="sort-controls">
          <label for="sortOption">Sort by:</label>
          <select id="sortOption">
            <option value="recent">Most Recent</option>
            <option value="hearts">Most Hearts</option>
            <option value="level">Highest Level</option>
            <option value="name">Name (A-Z)</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="profiles-container">
      <% bambis.forEach(bambi => { %>
        <div class="profile-card">
          <div class="card-banner" style="background: linear-gradient(135deg, <%= bambi.profileTheme?.primaryColor || '#fa81ff' %> 0%, <%= bambi.profileTheme?.secondaryColor || '#ff4fa2' %> 100%);">
            <% if (bambi.isVerified) { %>
              <div class="verified-badge-sm" title="Verified Bambi">
                <i class="fas fa-check-circle"></i>
              </div>
            <% } %>
          </div>
          <img src="<%= bambi.profilePictureUrl || '/images/default-profile.png' %>" alt="<%= bambi.displayName || bambi.username %>" class="profile-image">
          <div class="profile-info">
            <h3 class="profile-name"><a href="/bambis/<%= bambi.username %>"><%= bambi.displayName || bambi.username %></a></h3>
            <div class="profile-username">@<%= bambi.username %></div>
            <p class="profile-description"><%= bambi.description || 'No description provided' %></p>
            <div class="profile-details">
              <span class="profile-stat">
                <i class="fas fa-signal"></i> <%= bambi.level || 0 %>
              </span>
              <span class="profile-stat">
                <i class="fas fa-heart" style="color: #ff4fa2;"></i> 
                <%= bambi.hearts ? bambi.hearts.count : 0 %>
              </span>
              <span class="profile-stat">
                <i class="fas fa-tag"></i> <%= bambi.triggers ? bambi.triggers.length : 0 %>
              </span>
            </div>
            <a href="/bambis/<%= bambi.username %>" class="view-profile-btn">View Profile</a>
          </div>
        </div>
      <% }) %>
    </div>
    
    <!-- Pagination with enhanced styling -->
    <% if (locals.totalPages && totalPages > 1) { %>
      <div class="pagination">
        <% if (currentPage > 1) { %>
          <a href="/bambis?page=<%= currentPage - 1 %>" class="page-nav prev" aria-label="Previous page">
            <i class="fas fa-chevron-left"></i> Previous
          </a>
        <% } else { %>
          <span class="page-nav prev disabled"><i class="fas fa-chevron-left"></i> Previous</span>
        <% } %>
        
        <div class="page-numbers">
          <% 
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            if (endPage - startPage < 4) {
              startPage = Math.max(1, endPage - 4);
            }
          %>
          
          <% if (startPage > 1) { %>
            <a href="/bambis?page=1">1</a>
            <% if (startPage > 2) { %>
              <span class="ellipsis">...</span>
            <% } %>
          <% } %>
          
          <% for (let i = startPage; i <= endPage; i++) { %>
            <% if (i === currentPage) { %>
              <span class="active"><%= i %></span>
            <% } else { %>
              <a href="/bambis?page=<%= i %>"><%= i %></a>
            <% } %>
          <% } %>
          
          <% if (endPage < totalPages) { %>
            <% if (endPage < totalPages - 1) { %>
              <span class="ellipsis">...</span>
            <% } %>
            <a href="/bambis?page=<%= totalPages %>"><%= totalPages %></a>
          <% } %>
        </div>
        
        <% if (currentPage < totalPages) { %>
          <a href="/bambis?page=<%= currentPage + 1 %>" class="page-nav next" aria-label="Next page">
            Next <i class="fas fa-chevron-right"></i>
          </a>
        <% } else { %>
          <span class="page-nav next disabled">Next <i class="fas fa-chevron-right"></i></span>
        <% } %>
      </div>
    <% } %>
  <% } else if (!locals.error) { %>
    <div class="empty-state profiles-empty">
      <i class="fas fa-users empty-icon"></i>
      <h3>No bambi profiles found</h3>
      <p>Be the first to create one!</p>
    </div>
  <% } %>
<% } %>

<!-- Add JavaScript to handle tabbing and other interactions -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        
        // Remove active class from all buttons and tabs
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to current button and tab
        button.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // Web Share API for profile sharing
    const shareButton = document.getElementById('shareProfileBtn');
    if (shareButton) {
      shareButton.addEventListener('click', () => {
        const profileName = document.querySelector('.profile-name').textContent;
        const profileUrl = window.location.href;
        
        if (navigator.share) {
          navigator.share({
            title: `${profileName} on Bambisleep.chat`,
            text: `Check out ${profileName}'s profile on Bambisleep.chat!`,
            url: profileUrl
          }).catch(err => {
            console.log('Share failed:', err);
            fallbackShare(profileUrl);
          });
        } else {
          fallbackShare(profileUrl);
        }
      });
    }
    
    function fallbackShare(url) {
      // Fallback for browsers that don't support Web Share API
      navigator.clipboard.writeText(url)
        .then(() => {
          const notification = document.createElement('div');
          notification.className = 'share-notification';
          notification.innerHTML = '<i class="fas fa-check"></i> Profile URL copied to clipboard!';
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
          }, 3000);
        })
        .catch(() => {
          alert('Copy this URL to share: ' + url);
        });
    }
    
    // Character counter for descriptions
    const descriptionEdit = document.getElementById('descriptionEdit');
    const descriptionCharCount = document.getElementById('descriptionCharCount');
    const createDescription = document.getElementById('description');
    const createDescriptionCharCount = document.getElementById('createDescriptionCharCount');
    
    if (descriptionEdit && descriptionCharCount) {
      descriptionEdit.addEventListener('input', () => {
        const count = descriptionEdit.value.length;
        descriptionCharCount.textContent = count;
        
        if (count > 500) {
          descriptionCharCount.classList.add('exceeded');
        } else {
          descriptionCharCount.classList.remove('exceeded');
        }
      });
      
      // Trigger initial count
      descriptionEdit.dispatchEvent(new Event('input'));
    }
    
    if (createDescription && createDescriptionCharCount) {
      createDescription.addEventListener('input', () => {
        const count = createDescription.value.length;
        createDescriptionCharCount.textContent = count;
        
        if (count > 500) {
          createDescriptionCharCount.classList.add('exceeded');
        } else {
          createDescriptionCharCount.classList.remove('exceeded');
        }
      });
      
      // Trigger initial count
      createDescription.dispatchEvent(new Event('input'));
    }
    
    // File upload preview
    const fileInput = document.getElementById('profilePictureEdit');
    const uploadButton = document.getElementById('triggerFileUpload');
    const selectedFileName = document.getElementById('selectedFileName');
    const currentProfilePic = document.getElementById('currentProfilePic');
    
    if (fileInput && uploadButton) {
      uploadButton.addEventListener('click', () => fileInput.click());
      
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
          selectedFileName.textContent = fileInput.files[0].name;
          
          // Preview image
          const reader = new FileReader();
          reader.onload = function(e) {
            currentProfilePic.src = e.target.result;
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          selectedFileName.textContent = 'No file selected';
        }
      });
    }
    
    // Theme customizer preview
    const primaryColorInput = document.getElementById('primaryColor');
    const secondaryColorInput = document.getElementById('secondaryColor');
    const textColorInput = document.getElementById('textColor');
    const themePreview = document.getElementById('themePreview');
    const themePresets = document.querySelectorAll('.theme-preset');
    
    function updateThemePreview() {
      if (primaryColorInput && secondaryColorInput && textColorInput && themePreview) {
        const primaryColor = primaryColorInput.value;
        const secondaryColor = secondaryColorInput.value;
        const textColor = textColorInput.value;
        
        themePreview.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
        themePreview.querySelector('span').style.color = textColor;
      }
    }
    
    if (primaryColorInput && secondaryColorInput && textColorInput) {
      [primaryColorInput, secondaryColorInput, textColorInput].forEach(input => {
        input.addEventListener('input', updateThemePreview);
      });
    }
    
    if (themePresets) {
      themePresets.forEach(preset => {
        preset.addEventListener('click', () => {
          const primary = preset.getAttribute('data-primary');
          const secondary = preset.getAttribute('data-secondary');
          const text = preset.getAttribute('data-text');
          
          primaryColorInput.value = primary;
          secondaryColorInput.value = secondary;
          textColorInput.value = text;
          
          updateThemePreview();
        });
      });
    }
    
    // Triggers functionality
    const newTriggerInput = document.getElementById('newTrigger');
    const addTriggerBtn = document.getElementById('addTriggerBtn');
    const triggersList = document.getElementById('triggersList');
    
    function addTrigger() {
      if (newTriggerInput && triggersList) {
        const triggerText = newTriggerInput.value.trim();
        
        if (triggerText) {
          // Check for duplicates
          const existingTriggers = Array.from(triggersList.querySelectorAll('.trigger-pill'))
            .map(pill => pill.getAttribute('data-value').toLowerCase());
            
          if (!existingTriggers.includes(triggerText.toLowerCase())) {
            const newTrigger = document.createElement('div');
            newTrigger.className = 'trigger-pill';
            newTrigger.setAttribute('data-value', triggerText);
            newTrigger.innerHTML = `${triggerText}<span class="remove-trigger">×</span>`;
            
            triggersList.appendChild(newTrigger);
            newTriggerInput.value = '';
            
            // Add event listener to the remove button
            const removeBtn = newTrigger.querySelector('.remove-trigger');
            removeBtn.addEventListener('click', () => {
              newTrigger.remove();
            });
          }
        }
      }
    }
    
    if (newTriggerInput) {
      newTriggerInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addTrigger();
        }
      });
    }
    
    if (addTriggerBtn) {
      addTriggerBtn.addEventListener('click', (e) => {
        e.preventDefault();
        addTrigger();
      });
    }
    
    // Set up existing trigger removal
    document.querySelectorAll('.remove-trigger').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.parentElement.remove();
      });
    });
    
    // Social links functionality
    const addSocialLinkBtn = document.getElementById('addSocialLinkBtn');
    const socialLinksList = document.getElementById('socialLinksList');
    
    if (addSocialLinkBtn && socialLinksList) {
      addSocialLinkBtn.addEventListener('click', () => {
        const newIndex = socialLinksList.querySelectorAll('.social-link-item').length;
        
        const newSocialLink = document.createElement('div');
        newSocialLink.className = 'social-link-item';
        newSocialLink.setAttribute('data-index', newIndex);
        newSocialLink.innerHTML = `
          <select name="socialPlatform" class="social-platform-select">
            <option value="twitter">Twitter</option>
            <option value="instagram">Instagram</option>
            <option value="discord">Discord</option>
            <option value="reddit">Reddit</option>
            <option value="other">Other</option>
          </select>
          <input type="text" name="socialUrl" placeholder="https://">
          <button type="button" class="remove-social-btn">×</button>
        `;
        
        socialLinksList.appendChild(newSocialLink);
        
        // Add event listener to the remove button
        const removeBtn = newSocialLink.querySelector('.remove-social-btn');
        removeBtn.addEventListener('click', () => {
          newSocialLink.remove();
        });
      });
      
      // Set up existing social link removal
      document.querySelectorAll('.remove-social-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.social-link-item').remove();
        });
      });
    }
    
    // Edit form show/hide
    const editProfileBtn = document.getElementById('editProfileBtn');
    const closeEditFormBtn = document.getElementById('closeEditForm');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editForm = document.getElementById('editForm');
    
    if (editProfileBtn && editForm) {
      editProfileBtn.addEventListener('click', () => {
        editForm.classList.add('visible');
      });
    }
    
    if (closeEditFormBtn && editForm) {
      closeEditFormBtn.addEventListener('click', () => {
        editForm.classList.remove('visible');
      });
    }
    
    if (cancelEditBtn && editForm) {
      cancelEditBtn.addEventListener('click', () => {
        editForm.classList.remove('visible');
      });
    }
  });
</script>