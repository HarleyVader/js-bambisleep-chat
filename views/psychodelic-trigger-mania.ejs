<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head') %>
        <title>Psychodelic Trigger Mania</title>
        <style>
            #eyeCursor {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
            }
        </style>
</head>

<body>
    <%- include('partials/nav') %>
        <div>
            <h1>Psychodelic Trigger Mania</h1>
            <input type="file" id="upload-file" accept=".txt">
            <p id="message"></p>
        </div>
        <div id="chat-container">
            <div id="response-container">
                <div id="eyeCursor">
                    <div id="eye" aria-label="Eye Cursor"></div>
                </div>
            </div>
        </div>

        <script src="./js/psychodelic-trigger-mania.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
        <script src="./js/bootstrap.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="./js/responsive.js"></script>
        <script>
            const audio = document.createElement('audio');
            document.body.appendChild(audio);
            let _audioArray = [];
            let state = true;
            let text = '';

            document.getElementById('upload-file').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const fileContent = e.target.result;
                        processText(fileContent);
                    };
                    reader.readAsText(file);
                }
            });

            function processText(text) {
                let sentences = text.split(/(?<=[:;,.!?]["']?)\s+|\n+/g).filter(sentence => sentence.trim() !== '');
                for (let sentence of sentences) {
                    _textArray.push(sentence);
                    console.log('Text array:', _textArray);
                    if (state) {
                        handleAudioEnded();
                    }
                    sentence = '';
                }
                applyUppercaseStyle();
            }

            function handleAudioEnded() {
                if (_textArray.length > 0) {
                    state = false;
                    let _text = _textArray.shift();
                } else if (_textArray.length === 0) {
                    state = true;
                    return;
                }
                arrayPushToo(_audioArray, _text);
                do_tts(_audioArray);
            }

            function handleAudioPlay() {
                console.log('Audio is playing');
                const duration = audio.duration * 1000;
                new Promise(resolve => setTimeout(resolve, duration));
                flashTrigger(text, duration);
                const messageElement = document.createElement('p');
                messageElement.textContent = text;
                console.log('Text reply: ', messageElement.textContent);
                if (response.firstChild) {
                    response.insertBefore(messageElement, response.firstChild);
                } else {
                    response.appendChild(messageElement);
                }
                applyUppercaseStyle();
            }

            function arrayPushToo(array, text) {
                const parts = splitArray(text, 1);
                parts.forEach(part => {
                    fetch(`/api/tts?text=${encodeURIComponent(part.join(' '))}`)
                        .then(response => response.json())
                        .then(data => {
                            array.push(data);
                        });
                });
            }

            function splitArray(array, partSize) {
                let result = [];
                for (let i = 0; i < array.length; i += partSize) {
                    result.push(array.slice(i, i + partSize));
                }
                return result;
            }

            async function do_tts(_audioArray) {
                document.querySelector("#message").textContent = "Synthesizing...";

                while (_audioArray.length > 0) {
                    let currentURL = _audioArray.shift();
                    audio.src = currentURL;
                    console.log("audio.src ", audio.src);
                    audio.load();
                    await new Promise((resolve, reject) => {
                        audio.onloadedmetadata = function () {
                            console.log("audio ", audio);
                            console.log("audio.duration ", audio.duration);
                            document.querySelector("#message").textContent = "Playing...";
                            audio.play();
                        };
                        audio.onended = function () {
                            console.log("audio ended");
                            document.querySelector("#message").textContent = "Finished!";
                            resolve();
                        };
                        audio.onerror = function (e) {
                            console.error("Error playing audio:", e);
                            document.querySelector("#message").textContent = "Error playing audio." + e;
                            reject(e);
                        };
                    });
                }
            }

            audio.addEventListener('ended', handleAudioEnded);
            audio.addEventListener('play', handleAudioPlay);
        </script>
</body>

</html>