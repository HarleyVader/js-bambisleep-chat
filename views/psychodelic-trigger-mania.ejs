<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head') %>
        <title>Psychodelic Trigger Mania</title>
        <style>
            #eyeCursor {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
            }
        </style>
</head>

<body>
    <%- include('partials/nav') %>
        <div>
            <h1>Psychodelic Trigger Mania</h1>
            <input type="file" id="upload-file" accept=".txt">
            <p id="message"></p>
        </div>
        <div id="chat-container">
            <div id="response-container">
                <div id="eyeCursor">
                    <div id="eye" aria-label="Eye Cursor"></div>
                </div>
            </div>
        </div>

        <script src="./js/psychodelic-trigger-mania.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
        <script src="./js/bootstrap.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="./js/responsive.js"></script>
        <script src="./js/text2speech.js"></script>
        <script>
            const audio = document.createElement('audio');
            document.body.appendChild(audio);
            let _audioArray = [];

            socket.on('response', async (message) => {
                const messageText = message;
                const sentences = messageText.split(/(?<=[:;,.!?]["']?)\s+/g);
                for (let sentence of sentences) {
                    _textArray.push(sentence);
                    console.log('Text array:', _textArray);
                    if (state) {
                        handleAudioEnded();
                    }
                    sentence = '';
                }
                applyUppercaseStyle();
            });

            function handleAudioEnded() {
                if (_textArray.length > 0) {
                    state = false;
                    text = _textArray.shift();
                } else if (_textArray.length === 0) {
                    state = true;
                    return;
                }
                arrayPush(_audioArray, text);
                do_tts(_audioArray);
            }

            function handleAudioPlay() {
                console.log('Audio is playing');
                const duration = audio.duration * 1000;
                new Promise(resolve => setTimeout(resolve, duration));
                flashTrigger(text, duration);
                const messageElement = document.createElement('p');
                messageElement.textContent = text;
                console.log('Text reply: ', messageElement.textContent);
                if (response.firstChild) {
                    response.insertBefore(messageElement, response.firstChild);
                } else {
                    response.appendChild(messageElement);
                }
                applyUppercaseStyle();
            }

            audio.addEventListener('ended', handleAudioEnded);
            audio.addEventListener('play', handleAudioPlay);
        </script>
</body>

</html>